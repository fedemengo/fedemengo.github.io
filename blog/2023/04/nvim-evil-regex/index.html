<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>How I made nvim 300x faster | fedemengo</title>
    <meta name="author" content="fedemengo  ">
    <meta name="description" content="Tracking down an evil regex in vim and neovim">
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website">


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700%7CRoboto+Slab:100,300,400,500,700%7CMaterial+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light">

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/code.png">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://fedemengo.github.io/blog/2023/04/nvim-evil-regex/">

    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark">

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>

    <!-- Online 3D Viewer -->
    <script src="/assets/js/o3dv/o3dv.min.js"></script>
    <script>
        OV.SetExternalLibLocation ('libs'); // tell the engine where to find the libs folder
        OV.Init3DViewerElements (); // init all viewers on the page
    </script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/">fedemengo</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->

              <!-- Toogle theme mode -->
              <li class="toggle-container">
                <button id="light-toggle" title="Change theme">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <!-- Scrolling Progress Bar -->
      <progress id="progress" value="0">
        <div class="progress-container">
          <span class="progress-bar"></span>
        </div>
      </progress>
    </header>


    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">How I made nvim 300x faster</h1>
    <p class="post-meta">April 23, 2023</p>
    <p class="post-tags">
      <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>
        ·  
        <a href="/blog/tag/vim">
          <i class="fas fa-hashtag fa-sm"></i> vim</a>  
          <a href="/blog/tag/nvim">
          <i class="fas fa-hashtag fa-sm"></i> nvim</a>  
          <a href="/blog/tag/regex">
          <i class="fas fa-hashtag fa-sm"></i> regex</a>  
          
        ·  
        <a href="/blog/category/debugging">
          <i class="fas fa-tag fa-sm"></i> debugging</a>  
          

    </p>
  </header>

  <article class="post-content">
    <h2 id="intro">Intro</h2>

<p>For a while, I’ve been working on a side <a href="https://github.com/fedemengo/d2bist" rel="external nofollow noopener" target="_blank">project</a> that generates files with many 0s and 1s. As nvim is my primary editor, I frequently need to check or modify the contents of these files. However, to my great annoyance, whenever the files contained more than, let’s say, tens of thousands of bit characters, nvim would hang for several seconds, minutes, or until I would SIGKILL it.</p>

<p>This kept happening, so I tried opening the same file with plain vim and to my surprise, the file would open up instantly. There had to be something wrong with my config, I thought. After all, adding more and more plugins to nvim undoubtedly makes the editor heavier and slower. It was time to find out where the problem was.</p>

<h2 id="how">How</h2>

<p>I never had to debug performance issues in nvim before, so I didn’t really have much to start with. My first suspicion was that the slow down was cause by some plugins. I tried to binary-search the plugin causing problems but even without plugins opening up that file was still slow.</p>

<p>I didn’t havy many other ideas, looking at the helper I discovered the <code class="language-plaintext highlighter-rouge">--startuptime</code> flag. Since I didn’t want to mess up my configuration I launched a docker container, clone and compile nvim. I made sure the problem was still present in the version from master and created an empty <code class="language-plaintext highlighter-rouge">init.lua</code>.</p>

<p>Finally I launched</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ff1d74dcbc84:~# <span class="nb">time </span>nvim /test/data/data/pi_30_000 <span class="nt">--startuptime</span> vim-startup.log +qall

real    0m6.142s
user    0m6.123s
sys     0m0.010s
</code></pre></div></div>

<p>which generated</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>times in msec
 clock   self+sourced   self:  sourced script
 clock   elapsed:              other lines

000.013  000.013: --- NVIM STARTING ---
001.096  001.084: event init
001.994  000.897: early init
002.122  000.129: locale set
002.560  000.438: init first window
003.937  001.377: inits 1
003.996  000.058: window checked
....
018.257  000.129  000.129: sourcing /usr/share/nvim/runtime/plugin/man.lua
018.271  002.238: loading rtp plugins
018.389  000.118: loading packages
018.676  000.287: loading after plugins
018.687  000.011: inits 3
019.861  001.174: reading ShaDa
027.129  001.244  001.244: require('vim.filetype')
029.058  001.187  001.187: require('vim.filetype.detect')
6048.212  000.048  000.048: sourcing /usr/share/nvim/runtime/scripts.vim
6048.316  6025.976: opening buffers
6048.352  000.036: BufEnter autocommands
6048.355  000.003: editing files in windows
</code></pre></div></div>

<p>Looking at the logs, it’s clear that something bad happened between <code class="language-plaintext highlighter-rouge">029.058</code> and <code class="language-plaintext highlighter-rouge">6048.212</code>. In particular, <code class="language-plaintext highlighter-rouge">require('vim.filetype.detect')</code> took \(\approx 6\) seconds.</p>

<p>Armed with <code class="language-plaintext highlighter-rouge">rg</code> and <code class="language-plaintext highlighter-rouge">fd</code>, after some code diving, I understood what that line did. As the name suggests, it’s used to infer the file type. There are a couple of ways nvim infers the file type. In case it’s not obvious from the extension, it first checks for <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)" rel="external nofollow noopener" target="_blank">shebangs</a> and, if necessary, it attempts to guess the filetype from the file content.</p>

<p>And that’s where my problem was. The file contents are fed to a set of regex that, in case of a successful match, assigns a known filetype. For most of the regex, it’s enough to test the first few lines of the file content. In my case, the file was a single long line of characters (30k to be exact). So my first idea was to limit the line each regex has to test to some “reasonable” upper bound, I think I set 1000.</p>

<p>So I changed that, recompiled nvim, and opened up the file again.</p>

<p>Yep, the fix worked!</p>

<p>I pushed the fix and opened a PR. After some time, a nvim core maintainer had a chance to look at the fix and mentioned that nvim logic matches vim’s one. So to prevent any major divergence between the two, they suggested I push the fix to vim first, and in case it was accepted, they would port it to nvim. I think that’s only fair.</p>

<p>But could I really push that fix to vim? After all, vim didn’t suffer from this, so it seemed unreasonable to cap the file content to solve performance problems that were not there. I wanted to fix the issue where it made more sense.</p>

<p>After some rubber ducking with ChatGPT and some looking around the internet, I read that vim regex engine is particularly efficient. Nvim, on the other hand, uses Lua’s builtin regex. Could it be that the two had this magnitude of performance difference? Only one way to find out. Let’s write some code to test it.</p>

<p>So I basically rewrote <a href="https://github.com/neovim/neovim/blob/53f36806f1b5107c0570ffbf57180a8e08f45b2e/runtime/lua/vim/filetype/detect.lua#L1660" rel="external nofollow noopener" target="_blank">this</a> into a script</p>
<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">local</span> <span class="n">patterns_text</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"^#compdef\\&gt;"</span><span class="p">,</span>
    <span class="s2">"^#autoload\\&gt;"</span><span class="p">,</span>
    <span class="s2">"^From [a-zA-Z][a-zA-Z_0-9%.=%-]*(@[^ ]*)? .* 19%d%d$"</span><span class="p">,</span>
    <span class="s2">"^From [a-zA-Z][a-zA-Z_0-9%.=%-]*(@[^ ]*)? .* 20%d%d$"</span><span class="p">,</span>
    <span class="s2">"^From %- .* 19%d%d$"</span><span class="p">,</span>
    <span class="s2">"^From %- .* 20%d%d$"</span><span class="p">,</span>
    <span class="s2">"^&lt;[%%&amp;].*&gt;"</span><span class="p">,</span>
    <span class="s1">'^" *[vV]im$['</span><span class="p">,</span>
    <span class="s2">"%-%*%-.*[cC]%+%+.*%-%*%-"</span><span class="p">,</span>
    <span class="s2">"^\\*\\* LambdaMOO Database, Format Version \\%([1-3]\\&gt;\\)\\@!\\d\\+ \\*\\*$"</span><span class="p">,</span>
    <span class="s2">"^\\(diff\\&gt;\\|Only in \\|\\d\\+\\(,\\d\\+\\)\\=[cda]\\d\\+\\&gt;\\|# It was generated by makepatch \\|Index:\\s\\+\\f\\+\\r\\=$\\|===== \\f\\+ \\d\\+\\.\\d\\+ vs edited\\|==== //\\f\\+#\\d\\+\\|# HG changeset patch\\)"</span><span class="p">,</span>
    <span class="s2">"^%%![ \t]*PS"</span><span class="p">,</span>
    <span class="s2">"^ *proc[nd] *$"</span><span class="p">,</span>
    <span class="s2">"^%*%*%*%*  Purify"</span><span class="p">,</span>
    <span class="s2">"&lt;%?%s*xml.*%?&gt;"</span><span class="p">,</span>
    <span class="s2">"</span><span class="se">\\</span><span class="s2">&lt;DTD\\s\\+XHTML\\s"</span><span class="p">,</span>
    <span class="s2">"</span><span class="se">\\</span><span class="s2">c&lt;!DOCTYPE\\s\\+html\\&gt;"</span><span class="p">,</span>
    <span class="s2">"^%%PDF%-"</span><span class="p">,</span>
    <span class="s2">"^%x%x%x%x%x%x%x: %x%x ?%x%x ?%x%x ?%x%x "</span><span class="p">,</span>
    <span class="s2">"^RCS file:"</span><span class="p">,</span>
    <span class="s2">"^CVS:"</span><span class="p">,</span>
    <span class="s2">"^CVS: "</span><span class="p">,</span>
    <span class="s2">"^!R!"</span><span class="p">,</span>
    <span class="s2">"^SEND%-PR:"</span><span class="p">,</span>
    <span class="s2">"^SNNS network definition file"</span><span class="p">,</span>
    <span class="s2">"^SNNS pattern definition file"</span><span class="p">,</span>
    <span class="s2">"^SNNS result file"</span><span class="p">,</span>
    <span class="s2">"^%%.-[Vv]irata"</span><span class="p">,</span>
    <span class="s2">"[0-9:%.]* *execve%("</span><span class="p">,</span>
    <span class="s2">"^__libc_start_main"</span><span class="p">,</span>
    <span class="s2">"^\\* $$ JOB\\&gt;"</span><span class="p">,</span>
    <span class="s2">"^// *JOB\\&gt;"</span><span class="p">,</span>
    <span class="s2">"K &amp; K  Associates"</span><span class="p">,</span>
    <span class="s2">"TAK 2000"</span><span class="p">,</span>
    <span class="s2">"S Y S T E M S   I M P R O V E D "</span><span class="p">,</span>
    <span class="s2">"Run Date: "</span><span class="p">,</span>
    <span class="s2">"Node    File  1"</span><span class="p">,</span>
    <span class="s2">"^==%d+== valgrind"</span><span class="p">,</span>
    <span class="s2">"^==%d+== Using valgrind"</span><span class="p">,</span>
    <span class="s2">"PACKAGE DOCUMENTATION$"</span><span class="p">,</span>
    <span class="s2">"^##RenderMan"</span><span class="p">,</span>
    <span class="s2">"exec%s%+%S*scheme"</span><span class="p">,</span>
    <span class="s2">"^\\(commit\\|tree\\|object\\) \\x\\{40,\\}\\&gt;\\|^tag \\S\\+$"</span><span class="p">,</span>
    <span class="s2">"%-%*%-.*erlang.*%-%*%-"</span><span class="p">,</span>
    <span class="s2">"^%%YAML"</span><span class="p">,</span>
    <span class="s2">"^#.*by RouterOS"</span><span class="p">,</span>
    <span class="s2">"^#n%s"</span><span class="p">,</span>
    <span class="s2">"^#n$"</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">local</span> <span class="k">function</span> <span class="nf">match_from_text</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">#</span><span class="n">patterns_text</span> <span class="k">do</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">patterns_text</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="nb">next</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">#</span><span class="n">patterns_text</span> <span class="k">then</span>
            <span class="nb">next</span> <span class="o">=</span> <span class="n">patterns_text</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">end</span>
        <span class="kd">local</span> <span class="n">start_time</span> <span class="o">=</span> <span class="nb">os.clock</span><span class="p">()</span>
        <span class="n">contents</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span><span class="n">find</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="nb">os.clock</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">string.format</span><span class="p">(</span><span class="s2">"curr: '%s', Time: %.3fs. next: '%s'"</span><span class="p">,</span> <span class="n">curr</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">,</span> <span class="nb">next</span><span class="p">))</span>
	<span class="k">end</span>
<span class="k">end</span>

<span class="kd">local</span> <span class="n">file</span> <span class="o">=</span> <span class="nb">io.open</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">"r"</span><span class="p">)</span>
<span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="kc">nil</span> <span class="k">then</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"file not found"</span><span class="p">)</span>
<span class="k">else</span>
    <span class="kd">local</span> <span class="n">content</span> <span class="o">=</span> <span class="n">file</span><span class="p">:</span><span class="n">read</span><span class="p">(</span><span class="s2">"*all"</span><span class="p">)</span>
    <span class="n">file</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
    <span class="n">match_from_text</span><span class="p">({</span><span class="n">content</span><span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>and run it against the file that was causing me problems <code class="language-plaintext highlighter-rouge">lua test.lua pi_30_000</code></p>

<p>Soon enough I had found the problematic regex</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curr: '^RCS file:', Time: 0.000s. next: '^CVS:'
curr: '^CVS:', Time: 0.000s. next: '^CVS: '
curr: '^CVS: ', Time: 0.000s. next: '^!R!'
curr: '^!R!', Time: 0.000s. next: '^SEND%-PR:'
curr: '^SEND%-PR:', Time: 0.000s. next: '^SNNS network definition file'
curr: '^SNNS network definition file', Time: 0.000s. next: '^SNNS pattern definition file'
curr: '^SNNS pattern definition file', Time: 0.000s. next: '^SNNS result file'
curr: '^SNNS result file', Time: 0.000s. next: '^%%.-[Vv]irata'
curr: '^%%.-[Vv]irata', Time: 0.000s. next: '[0-9:%.]* *execve%('

curr: '[0-9:%.]* *execve%(', Time: 4.408s. next: '^__libc_start_main'

curr: '^__libc_start_main', Time: 0.000s. next: '^\* $$ JOB\&gt;'
curr: '^\* $$ JOB\&gt;', Time: 0.000s. next: '^// *JOB\&gt;'
curr: '^// *JOB\&gt;', Time: 0.000s. next: 'K &amp; K  Associates'
curr: 'K &amp; K  Associates', Time: 0.000s. next: 'TAK 2000'
curr: 'TAK 2000', Time: 0.000s. next: 'S Y S T E M S   I M P R O V E D '
curr: 'S Y S T E M S   I M P R O V E D ', Time: 0.000s. next: 'Run Date: '
</code></pre></div></div>

<p>The regex <code class="language-plaintext highlighter-rouge">[0-9:%.]* *execve%(</code> equivalent to <code class="language-plaintext highlighter-rouge">[0-9:.]* *execve(</code> without regex escape chars took \(\approx 4.4\) seconds to evaluate, which is crazy considering all the other regexes evaluated instantly. I’m no expert in regexes but I think the issues is with a backtracking explosion. Remember the <a href="https://en.wikipedia.org/wiki/String-searching_algorithm#Naive_string_search" rel="external nofollow noopener" target="_blank">naive string searching</a>?</p>

<p>Anyway, the trend was close to quadratic, on paper the regex had to perform \(\sum_{i=1}^N i = \frac{N(N+1)}{2} = O(N^2)\) matches.</p>

<figure>

  <picture>
    
    <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/blog/2023-04-23/nvim-plot-480.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/blog/2023-04-23/nvim-plot-800.webp"></source>
    <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/blog/2023-04-23/nvim-plot-1400.webp"></source>
    

    <!-- Fallback to the original file -->
    <img src="/assets/img/blog/2023-04-23/nvim-plot.png" class="img-fluid rounded" width="auto" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();">

  </picture>

</figure>

<p>I spent some time trying to understand why it was written that way, after all <code class="language-plaintext highlighter-rouge">[0-9:.]* *execve(</code> is equivalent to <code class="language-plaintext highlighter-rouge">execve(</code> given that both <code class="language-plaintext highlighter-rouge">[0-9:.]</code> and <code class="language-plaintext highlighter-rouge">\s</code> are matched zero or more times, so they don’t really matter. This would not have been the case if the regex had been anchored.</p>

<p>Finally! Something is actually wrong (in vim too) and should be fixed.</p>

<p>I gave it a shot with the simplified regex. Comparing the time to open up the file before the fix</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ff1d74dcbc84:~# <span class="nb">time </span>nvim /test/data/data/pi_30_000 +qall

real    0m6.142s
user    0m6.123s
sys     0m0.010s
</code></pre></div></div>

<p>and after the fix</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@ff1d74dcbc84:~# <span class="nb">time </span><span class="nv">VIMRUNTIME</span><span class="o">=</span>/neovim/runtime/ /neovim/build/bin/nvim /test/data/data/pi_30_000 +qall

real    0m0.021s
user    0m0.014s
sys     0m0.000s
</code></pre></div></div>
<p>just awesome.</p>

<p>I updated the PR in nvim and opened a PR in vim with the simplified version of the regex. I also noticed that the very same regex had undergone some changes and it also used to be anchored. I think somewhere along the line an edit wasn’t really equivalent, so I added a test to prevent future regressions. You know, just for good measure.</p>

<p>After some <a href="https://github.com/vim/vim/pull/12220" rel="external nofollow noopener" target="_blank">back and forth</a> with @brammool on how to tackle this, I ended up with a fix that eventually got <a href="https://github.com/vim/vim/commit/6e5a9f948221b52caaaf106079cb3430c4dd7c77" rel="external nofollow noopener" target="_blank">accepted</a> into vim codebase and <a href="https://github.com/neovim/neovim/commit/6d9f5b6bf0fc324b33ce01f74a6030c9271b1a01" rel="external nofollow noopener" target="_blank">ported</a> into nvim.</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	 || line4 =~ '^%.\{-}[Vv]irata'
	 || line5 =~ '^%.\{-}[Vv]irata'
    set ft=virata
<span class="err">
</span>    # Strace
<span class="gd">-  elseif line1 =~ '[0-9:.]* *execve(' || line1 =~ '^__libc_start_main'
</span><span class="gi">+    # inaccurate fast match first, then use accurate slow match
+  elseif (line1 =~ 'execve(' &amp;&amp; line1 =~ '^[0-9:.]* *execve(')
+	   || line1 =~ '^__libc_start_main'
</span>    set ft=strace
<span class="err">
</span>    # VSE JCL
    elseif line1 =~ '^\* $$ JOB\&gt;' || line1 =~ '^// *JOB\&gt;'
</code></pre></div></div>
<p>Now that I look at it I think <code class="language-plaintext highlighter-rouge">^[0-9:.]* *execve(</code> was enough to guarantee optimal performances and correctness, but whatever.</p>

<p>And that folks, is how I made nvim \(6.142 / 0.021 = 292.48 \approx 300\) times faster ;)</p>

<h2 id="conclusion">Conclusion</h2>

<p>This was an interesting and fun exercise in troubleshooting.</p>

<p>It made me appreciate open source and hate regex even more! After this was done I started to wonder if a tool to <a href="https://en.wikipedia.org/wiki/NFA_minimization" rel="external nofollow noopener" target="_blank">simplify</a> regexes exists and how <a href="https://cstheory.blogoverflow.com/2011/08/on-learning-regular-languages/" rel="external nofollow noopener" target="_blank">difficult</a> it would be to make one. Maybe I’ll give it a shot.</p>

<p>Another interesting way to investigate slow downs in nvim that I found is <a href="https://github.com/stevearc/profile.nvim" rel="external nofollow noopener" target="_blank">this</a> amazing profiling plugin. In case <code class="language-plaintext highlighter-rouge">--startuptime</code> doesn’t give enough or any actionable information.</p>


  </article>


  
    
    <br>
    <hr>
    <br>
    <ul class="list-disc pl-8"></ul>

    <!-- Adds related posts to the end of an article -->
    <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2>
    <p class="mb-2">Here are some more articles you might like to read next:</p>
  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/10/visualizing-cellular-automata/">Visualizing cellular automata</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2022/10/poincare-recurrence-time/">Poincaré recurrence time in cellular automata</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2021/01/tomtom-spark-linux/">TomTom Spark on Linux</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2020/11/ssh-local-forwarding/">SSH Local Forwarding</a>
  </li>

  

  <li class="my-2">
    <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2019/09/web-crawler/">Designing an efficient webcrawler</a>
  </li>

</div>

    </div>

    <!-- Footer -->    <footer class="sticky-bottom mt-5">
      <div class="container">
        © Copyright 2023 fedemengo  . Last updated: April 26, 2023.
      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>
  <script defer src="/assets/js/copy_code.js" type="text/javascript"></script>

    
  <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script>
  <script async src="https://badge.dimensions.ai/badge.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
    

<!-- Scrolling Progress Bar -->
<script type="text/javascript">
  /*
   * This JavaScript code has been adapted from the article 
   * https://css-tricks.com/reading-position-indicator/ authored by Pankaj Parashar, 
   * published on the website https://css-tricks.com on the 7th of May, 2014.
   * Couple of changes were made to the original code to make it compatible 
   * with the `al-foio` theme.
   */
  const progressBar = $("#progress");
  /*
   * We set up the bar after all elements are done loading.
   * In some cases, if the images in the page are larger than the intended
   * size they'll have on the page, they'll be resized via CSS to accomodate
   * the desired size. This mistake, however, breaks the computations as the
   * scroll size is computed as soon as the elements finish loading.
   * To account for this, a minimal delay was introduced before computing the
   * values.
   */
  window.onload = function () {
    setTimeout(progressBarSetup, 50);
  };
  /*
   * We set up the bar according to the browser.
   * If the browser supports the progress element we use that.
   * Otherwise, we resize the bar thru CSS styling
   */
  function progressBarSetup() {
    if ("max" in document.createElement("progress")) {
      initializeProgressElement();
      $(document).on("scroll", function() {
        progressBar.attr({ value: getCurrentScrollPosition() });
      });
      $(window).on("resize", initializeProgressElement);
    } else {
      resizeProgressBar();
      $(document).on("scroll", resizeProgressBar);
      $(window).on("resize", resizeProgressBar);
    }
  }
  /*
   * The vertical scroll position is the same as the number of pixels that
   * are hidden from view above the scrollable area. Thus, a value > 0 is
   * how much the user has scrolled from the top
   */
  function getCurrentScrollPosition() {
    return $(window).scrollTop();
  }

  function initializeProgressElement() {
    let navbarHeight = $("#navbar").outerHeight(true);
    $("body").css({ "padding-top": navbarHeight });
    $("progress-container").css({ "padding-top": navbarHeight });
    progressBar.css({ top: navbarHeight });
    progressBar.attr({
      max: getDistanceToScroll(),
      value: getCurrentScrollPosition(),
    });
  }
  /*
   * The offset between the html document height and the browser viewport
   * height will be greater than zero if vertical scroll is possible.
   * This is the distance the user can scroll
   */
  function getDistanceToScroll() {
    return $(document).height() - $(window).height();
  }

  function resizeProgressBar() {
    progressBar.css({ width: getWidthPercentage() + "%" });
  }
  // The scroll ratio equals the percentage to resize the bar
  function getWidthPercentage() {
    return (getCurrentScrollPosition() / getDistanceToScroll()) * 100;
  }
</script>

  </body>
</html>
